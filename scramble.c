//
// written by Doug Molineux 2/2/2012
// scramble - unscrambles a given word using aspell's word list that can be acquired like this:
// yum install aspell
// aspell dump master > words
// make sure the words file exists in the same directory as this program
//
// DJM - Modified 3/2/2012
// - Added support for unscrambling md5 hashes using openssl/md5.h include
// 
// DJM - Modified 3/1/2012
// - Added constants for max sizes of input and file line
// - Made the currentLine and input global for easy function access
//

#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<openssl/md5.h>

#define MAX_CHAR_SIZE 80

// declare the currentLine char that will contain the current line
// that the loop pulls out of the string list file
char currentLine[MAX_CHAR_SIZE];

// declare the input taken from user, md5 hash is 32 chars, so may need to be
// at least this value
char input[MAX_CHAR_SIZE];

// declare mode integer; 1 - no md5, 2 - md5
int mode = 1;

char md5Line[MAX_CHAR_SIZE];

// char *str2md5(const char *str[MAX_CHAR_SIZE], int length) {
char *str2md5(char *str[MAX_CHAR_SIZE], int length) {

	int n;
	MD5_CTX c;
	unsigned char digest[16];
	char *out = (char*)malloc(33);

	MD5_Init(&c);

	while (length > 0) {
        	if (length > 512) {
            		MD5_Update(&c, str, 512);
        	} else {
            		MD5_Update(&c, str, length);
        	}
        	length -= 512;
        	str += 512;
    	}

    	MD5_Final(digest, &c);

    	for (n = 0; n < 16; ++n) {
        	snprintf(&(out[n*2]), 16*2, "%02x", (unsigned int)digest[n]);
    	}

    	return out;
}


void resetVars() {

	currentLine[0] = 0;

	// md5Line[0] = 0;

	memset(md5Line, 0, sizeof(md5Line));

}

void removeNewline() {

	// removes the new line char at the end of each line, apparently brought in by fgets
        if(currentLine[strlen(currentLine) - 1] == '\n')
        	currentLine[strlen(currentLine) - 1] = 0;
	
}

void getUserInput() {

        // clear the screen
        system("clear");

	printf("\n\tScramble 0.2\n\n \tEnter mode (1 for normal, 2 for MD5):");

	scanf("%d", &mode);

        // prompt for a word to search
        printf("\n\tEnter Word:");

        // input word
        scanf("%s", &input);

}

int main() {

	// integer used for the counter
	int i = 0; 	

	// integer that can tell if found letters match number of given letters
	int fgLetters;

	// open the words file, that was generated by aspell dump master
	FILE *fp = fopen("words","r");

	// md5 = str2md5("hello", strlen("hello"));

	getUserInput();

	printf("\n");

	resetVars();

	// loop through each line
	while(fgets(currentLine, sizeof(currentLine), fp) != NULL) {

		removeNewline();

		// set the found / given letters to 0
		fgLetters = 0;

		if(mode == 1) {

			// first make sure that the lengths of the word and of the list word is the same
			if(strlen(currentLine) == strlen(input)) {

				// loop through each letter in the word given
				for(i = 0; i < strlen(input); i++) {

					// search the line for the current letter, if we find it increment fgLetters
					if(strchr(currentLine, input[i]) != NULL)
						fgLetters++;
	
				}
	
				// once we have finished looping through the word; evaluate fgLetters
				if(fgLetters == strlen(input)) {

					// fgLetters will be equal to the length of the word if each letter appears in the word
					printf("\tMatch: %s \n", currentLine);

				}

			}

		}
		else if(mode == 2) {

			strcpy(md5Line, str2md5(currentLine, strlen(currentLine)));

			if(strcmp(md5Line, input) == 0) {

				printf("\tMatch: %s \n", currentLine);

			}

		}

		resetVars();

	}

	fclose(fp);

	printf("\n\n");

	return 0;

}
